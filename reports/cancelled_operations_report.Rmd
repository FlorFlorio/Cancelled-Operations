---
title: |
  ![](logo_dm_uba.png){width=1in}  
  Análisis de series temporales de operaciones canceladas
author: "Lic. Malena Álvarez Brito, Ing. Florencia Florio"
date: "`r format(Sys.time(), '%B %Y')`"
output:
  pdf_document:
    latex_engine: xelatex
    number_sections: true
    fig_caption: true
    includes:
      in_header: header.tex
  html_document: default
mainfont: Arial
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)

library(knitr)
library(tidyverse)
library(zoo)
library(xts)
library(forecast)
library(seasonal)
library(ggpubr)
```

```{r data-loading}
operations <- readRDS("data/processed/cancelled_operations_1994_to_2019.rds")
day_beds_occupancy <- readRDS("data/processed/day_beds_occupancy_2010Q1_to_2020Q1.rds")
night_beds_occupancy <- readRDS("data/processed/overnight_beds_occupancy_2010Q1_to_2020Q1.rds")
```

> **Resumen**: Este es el resumen. Este es el resumen. Este es el resumen. Este es el resumen. Este es el resumen. Este es el resumen. Este es el resumen. Este es el resumen. Este es el resumen. Este es el resumen. Este es el resumen. Este es el resumen. Este es el resumen. (aproximadamente 250 palabras).

> Palabras clave: series de tiempo, sistema de salud, forecasting

# Introducción

Introducción. Explicar de dónde viene el dataset. Qué significa cada valor. Periodicidad de la serie (frecuencia de muestreo). Qué se entiende por operación "electiva". Qué tipo de instituciones son? públicas y privadas? O sólo públicas?

# Hipótesis y objetivos

Hipótesis y objetivos.

Objetivo: analizar la serie de tiempo de operaciones canceladas para descubrir patrones en su comportamiento, ver si existe correlación con ocupación de las camas de internación, hacer forecasting de porcentaje de cancelación. Todo esto podría contribuir a una mejor asignación de recursos del sistema de salud y toma de decisión de gestión sanitaria.

# Material y métodos

Material y métodos.

R, RStudio. Librerías: tidyverse, zoo, xts, forecast, seasonal.

# Resultados

Gráfico temporal de todas las series en el dataset de operaciones canceladas.

### Respecto al porcentaje de cancelaciones

Fuerte estacionalidad (sube, baja, sube, baja).
Algo pasó en 2001 que aumentó el porcentaje de cancelaciones (casi el doble que en otros trimestres).
Además, entre el 2000 y el 2010 parecería haber una tendencia a disminuir. Luego, en 2010 parece haber un cambio de tendencia y empieza a aumentar ligeramente.

### Respecto al total de opraciones

Clara tendencia a aumentar.

```{r series, fig.height=6}
operations %>% 
  pivot_longer(2:6, names_to = "serie", values_to = "valor") %>% 
  filter(serie %in% c("elective_admissions",
                      "cancelled_operations_perc",
                      "patients_not_treated_28_days_perc")) %>%
  ggplot(aes(x = year_quarter, y = valor)) +
  geom_line(group = 1) + 
  facet_grid(vars(serie), scales = "free_y") +
  xlab("") +
  theme(axis.text.x = element_text(angle = 60, hjust = 1))
```

Viendo el filtro moving average también se evidencia el aumento en 2001.

```{r moving-average, fig.height=3}
# convert to ts
x <- xts(operations[,"cancelled_operations_perc"], order.by = as.yearqtr(operations$year_quarter))
tt <- as.ts(as.zoo(x))

autoplot(tt, series="Data") +
  autolayer(ma(tt, 4), series = "4-MA") +
  xlab("Año") + ylab("Porcentaje de cancelación") +
  ggtitle("Operaciones canceladas") +
  scale_colour_manual(values = c("Data" = "grey50", "4-MA" = "red"),
                      breaks = c("Data", "4-MA"))
```

### Análisis a partir de los gráficos de estacionalidad

En el siguiente gráfico se ve que el pico fue en realidad en el último trimestre de 2000 pero que todo el 2000 fue alto. También el 2001 fue alto, aunque luego fue bajando.

Yo veo, además, que el primer y segundo trimestres suelen ser más bajos que el tercero y el cuarto. El 2010 fue distinto porque el Q4 fue bastante menor al Q3.

```{r seasonal-plot-year}
# seasonal plot
ggseasonplot(tt, year.labels = TRUE, year.labels.left = TRUE) +
  ylab("Porcentaje de cancelación") +
  ggtitle("Seasonal plot: cancelled operations")
```

En el siguiente gráfico se ve que los primeros dos trimestres son, en promedio, más bajos que el tercero y el cuarto.

```{r seasonal-plot-quarter, fig.height=3, fig.width=5, fig.align='center'}
ggsubseriesplot(tt) +
  ylab("Porcentaje de cancelación") +
  ggtitle("Seasonal subseries plot: cancelled operations")
```

### Autocorrelación

Se ve que el pico más alto está en 4. Esto es porque los datos tienen estacionalidad. Los picos tienden a tener una separación de 4 (observaciones) trimestres. Los múltiplos de 4 también tienen correlación alta pero va bajando. Forman picos debido a la estacionalidad.

El hecho de que la correlación sea positiva en casi todos los lags se debe a que la serie tiene una tendencia positiva.

```{r acf, fig.height=3, fig.width=5, fig.align='center'}
ggAcf(tt, lag.max = 24)
```
Gráfico de la fft de porcentaje de operaciones canceladas. Se distinguen 2 picos bien marcados (a parte del valor del índice 1...este sería el valor de continua???)

```{r fft, fig.height=3, fig.width=5, fig.align='center'}
# calcular la transformada rápida de fourier
fft <- fft(operations$cancelled_operations)

mod_fft <- Mod(fft) # tomo el módulo de la fft
mod_fft <- mod_fft[1:ceiling(length(mod_fft)/2)] # me quedo con la primer mitad (el resto es espejo)

ggplot() + geom_line(aes(x = seq_along(mod_fft), y = mod_fft))

# dónde y cuáles son los picos de la fft?
picos_fft <- data.frame(valor = mod_fft[order(mod_fft, decreasing=TRUE)[1:3], drop=FALSE],
                        posicion = order(mod_fft, decreasing=TRUE)[1:3])
kable(picos_fft)
```

Descomposición de la señal. El cuarto gráfico es como el de moving average. Después podemos ver con cuál nos quedamos.

```{r classical-decomposition}
tt %>% decompose(type="multiplicative") %>%
  autoplot() + xlab("Year") +
  ggtitle("Descomposición multiplicativa clásica")
```

## Forecasting

Forecast simple (preliminar).

```{r forecast, fig.height=3}
autoplot(tt) +
  autolayer(meanf(tt, h=11), series="Mean", PI=FALSE) +
  autolayer(naive(tt, h=11), series="Naïve", PI=FALSE) +
  autolayer(snaive(tt, h=11), series="Seasonal naïve", PI=FALSE) +
  ggtitle("Forecasts for quarterly cancelled operations") +
  xlab("Year") + ylab("Megalitres") +
  guides(colour=guide_legend(title="Forecast"))
```

### Auto ARIMA forecast

Se aplica un ARIMA automático con estacionalidad.

```{r auto-arima, fig.height=3}
arima_fit <- auto.arima(tt, seasonal = TRUE)
print(arima_fit)
plot(forecast(arima_fit, h = 20), include = 80)
```


## Correlación con ocupación de camas

#### Correlación con ocupación de camas por el día.

Mirando el gráfico de dispersión, no parece haber una relación tan clara entre ambas.

```{r corr-day-beds, fig.height=2, fig.width=5, fig.align='center'}
# filtro para que empiece desde el mismo punto que la serie de las camas
operations_2010_2019 <- operations %>%
  filter(year_quarter >= "2010 Q1") %>%
  select(cancelled_operations_perc) %>%
  unlist()

x2 <- xts(day_beds_occupancy[,2], order.by = as.yearqtr(day_beds_occupancy$year_quarter))
tt2 <- as.ts(as.zoo(x2))

autoplot(tt2)

day_beds_occupancy_2010_2019 <- day_beds_occupancy %>%
  filter(year_quarter <= "2019 Q3") %>%
  select(occupancy_all_types) %>%
  unlist()

df_db <- data.frame(op_10_19 = operations_2010_2019,
                 db_10_19 = day_beds_occupancy_2010_2019)

ggscatter(df_db, x = "db_10_19", y = "op_10_19", 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "pearson",
          xlab = "Day bed occupancy (%?)", ylab = "Cancelled operations (%)")

# correlación con ccf
ggCcf(operations_2010_2019, day_beds_occupancy_2010_2019, lag.max = 39)
```

#### Correlación con camas día+noche.

En el gráfico de dispersión se ve una relación entre ambas. En decir, cuando hay mucha ocupación de camas nocturnas, hay mayor porcentaje de cancelación de operaciones. Esta relación (aparentemente lineal) no implica causalidad.

```{r corr-overnight-beds, fig.height=2, fig.width=5, fig.align='center'}
x2 <- xts(night_beds_occupancy[,2], order.by = as.yearqtr(night_beds_occupancy$year_quarter))
tt2 <- as.ts(as.zoo(x2))

autoplot(tt2)

night_beds_occupancy_2010_2019 <- night_beds_occupancy %>%
  filter(year_quarter <= "2019 Q3") %>%
  select(occupancy_all_types) %>%
  unlist()

df_nb <- data.frame(op_10_19 = operations_2010_2019,
                    nb_10_19 = night_beds_occupancy_2010_2019)

ggscatter(df_nb, x = "nb_10_19", y = "op_10_19", 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "pearson",
          xlab = "Night bed occupancy (%?)", ylab = "Cancelled operations (%)")

# correlacion con ccf
ggCcf(operations_2010_2019, night_beds_occupancy_2010_2019, lag.max = 39)
```


# Discusión y conclusiones

# Bibliografía